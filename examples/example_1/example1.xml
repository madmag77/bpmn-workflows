<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             targetNamespace="http://example.com/definitions">
  <process id="IntentQA" name="Intent-Driven QA" isExecutable="true">

    <startEvent id="Start"/>

    <serviceTask id="IdentifyIntent" name="Identify User Intent"
                 camunda:expression="\${identify_user_intent(input_text)}"/>
    <sequenceFlow id="flow1" sourceRef="Start" targetRef="IdentifyIntent"/>

    <exclusiveGateway id="DecisionIntent"/>

    <sequenceFlow id="flow2" sourceRef="IdentifyIntent" targetRef="DecisionIntent"/>

    <sequenceFlow id="flow3" sourceRef="DecisionIntent" targetRef="Retrieve">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[\${intent == 'qa'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow4" sourceRef="DecisionIntent" targetRef="Summarize">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[\${intent == 'summarization'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow5" sourceRef="DecisionIntent" targetRef="AskUser" default="true"/>

    <serviceTask id="AskUser" name="Ask User"
                 camunda:expression="\${ask_user('Could you clarify your request?')}"/>
    <sequenceFlow id="flow6" sourceRef="AskUser" targetRef="Retrieve"/>

    <serviceTask id="Retrieve" name="Retrieve Chunks"
                 camunda:expression="\${retrieve_financial_documents(query)}"/>
    <sequenceFlow id="flow7" sourceRef="Retrieve" targetRef="EvaluateRelevance"/>

    <serviceTask id="EvaluateRelevance" name="Evaluate Relevance"
                 camunda:expression="\${evaluate_relevance(chunks)}"/>
    <sequenceFlow id="flow8" sourceRef="EvaluateRelevance" targetRef="DecisionRelevance"/>

    <exclusiveGateway id="DecisionRelevance"/>

    <sequenceFlow id="flow9" sourceRef="DecisionRelevance" targetRef="Generate">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[\${relevance == 'OK'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow10" sourceRef="DecisionRelevance" targetRef="Rephrase">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[\${relevance == 'BAD' && rephraseCount < 3}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow11" sourceRef="DecisionRelevance" targetRef="GenerateError" default="true"/>

    <serviceTask id="Rephrase" name="Rephrase Query"
                 camunda:expression="\${rephrase_query(query)}"/>
    <sequenceFlow id="flow12" sourceRef="Rephrase" targetRef="IncrementCounter"/>

    <serviceTask id="IncrementCounter" name="Increment Rephrase Count"
                 camunda:expression="\${increment_counter(new_query)}"/>
    <sequenceFlow id="flow13" sourceRef="IncrementCounter" targetRef="Retrieve"/>

    <serviceTask id="Summarize" name="Summarize"
                 camunda:expression="\${summarize(input_text)}"/>
    <sequenceFlow id="flow14" sourceRef="Summarize" targetRef="Generate"/>

    <serviceTask id="Generate" name="Generate Answer"
                 camunda:expression="\${generate_answer(source)}"/>
    <sequenceFlow id="flow15" sourceRef="Generate" targetRef="End"/>

    <serviceTask id="GenerateError" name="Generate Error"
                 camunda:expression="\${generate_answer('ERROR: no relevant chunks after retries')}"/>
    <sequenceFlow id="flow16" sourceRef="GenerateError" targetRef="End"/>

    <endEvent id="End"/>

  </process>
  <bpmndi:BPMNDiagram id="Diagram_1">
    <bpmndi:BPMNPlane id="Plane_1" bpmnElement="IntentQA">
      <bpmndi:BPMNShape id="Start_di" bpmnElement="Start">
        <omgdc:Bounds x="100" y="100" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="IdentifyIntent_di" bpmnElement="IdentifyIntent">
        <omgdc:Bounds x="250" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="DecisionIntent_di" bpmnElement="DecisionIntent">
        <omgdc:Bounds x="400" y="95" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="AskUser_di" bpmnElement="AskUser">
        <omgdc:Bounds x="400" y="200" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Retrieve_di" bpmnElement="Retrieve">
        <omgdc:Bounds x="550" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EvaluateRelevance_di" bpmnElement="EvaluateRelevance">
        <omgdc:Bounds x="700" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="DecisionRelevance_di" bpmnElement="DecisionRelevance">
        <omgdc:Bounds x="850" y="95" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Rephrase_di" bpmnElement="Rephrase">
        <omgdc:Bounds x="850" y="200" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="IncrementCounter_di" bpmnElement="IncrementCounter">
        <omgdc:Bounds x="1000" y="200" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Summarize_di" bpmnElement="Summarize">
        <omgdc:Bounds x="550" y="200" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Generate_di" bpmnElement="Generate">
        <omgdc:Bounds x="1000" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="GenerateError_di" bpmnElement="GenerateError">
        <omgdc:Bounds x="1000" y="150" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="End_di" bpmnElement="End">
        <omgdc:Bounds x="1150" y="100" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="flow1_di" bpmnElement="flow1">
        <omgdi:waypoint x="136" y="118"/>
        <omgdi:waypoint x="250" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow2_di" bpmnElement="flow2">
        <omgdi:waypoint x="350" y="118"/>
        <omgdi:waypoint x="400" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow3_di" bpmnElement="flow3">
        <omgdi:waypoint x="425" y="118"/>
        <omgdi:waypoint x="550" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow4_di" bpmnElement="flow4">
        <omgdi:waypoint x="425" y="118"/>
        <omgdi:waypoint x="550" y="240"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow5_di" bpmnElement="flow5">
        <omgdi:waypoint x="425" y="118"/>
        <omgdi:waypoint x="450" y="240"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow6_di" bpmnElement="flow6">
        <omgdi:waypoint x="500" y="240"/>
        <omgdi:waypoint x="550" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow7_di" bpmnElement="flow7">
        <omgdi:waypoint x="650" y="118"/>
        <omgdi:waypoint x="700" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow8_di" bpmnElement="flow8">
        <omgdi:waypoint x="800" y="118"/>
        <omgdi:waypoint x="850" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow9_di" bpmnElement="flow9">
        <omgdi:waypoint x="875" y="118"/>
        <omgdi:waypoint x="1000" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow10_di" bpmnElement="flow10">
        <omgdi:waypoint x="875" y="118"/>
        <omgdi:waypoint x="900" y="240"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow11_di" bpmnElement="flow11">
        <omgdi:waypoint x="875" y="118"/>
        <omgdi:waypoint x="1000" y="190"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow12_di" bpmnElement="flow12">
        <omgdi:waypoint x="900" y="240"/>
        <omgdi:waypoint x="1000" y="240"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow13_di" bpmnElement="flow13">
        <omgdi:waypoint x="1100" y="240"/>
        <omgdi:waypoint x="550" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow14_di" bpmnElement="flow14">
        <omgdi:waypoint x="650" y="240"/>
        <omgdi:waypoint x="1000" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow15_di" bpmnElement="flow15">
        <omgdi:waypoint x="1100" y="118"/>
        <omgdi:waypoint x="1150" y="118"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="flow16_di" bpmnElement="flow16">
        <omgdi:waypoint x="1100" y="190"/>
        <omgdi:waypoint x="1150" y="118"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
